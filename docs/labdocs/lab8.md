# lab8: 文件系统

## 实验目的
* 了解文件系统的功能
* 实现简单的文件系统
* 了解虚拟文件系统

## 实验内容
lab8 之前, 我们都没有文件的概念. 所有用户程序都被打包放在内核镜像中.
但为了管理信息档案, 文件是一个非常基本的概念.
所以 rcore 还要有文件系统支持.

在本实验中, 你需要通过阅读实验指导书和 rcore 代码, 了解文件系统的概念.
之后参考已有的磁盘文件系统 (SFS), 实现简单的内存文件系统 (ramfs).

## 练习

### 练习 0
* 移植已有结果

### 练习 1
*无需编码*

阅读实验指导书及参考书目, 理解文件系统的概念, 并在报告中回答如下问题
1. ...
2. ...

### 练习 2
*需要编码*

参考 rcore 中的磁盘文件系统, 实现一个简单的 ramfs, 要求支持
* 文件创建, 读写, 删除
* 目录

## 框架变化
变化的文件主要有
| 增改删 | crate: 文件 | 变化 |
| --- | --- | --- |
| M | kernel: process/context.rs | 让每个进程管理自己相关的文件 |
| + | kernel: fs.rs | stdin 和 stdout 的处理 |
| M | kernel: syscall.rs | 加入文件系统相关 syscall |
| + | simple-file-system: * | 你应当参考这个文件系统的实现 |

## 相关知识
### 文件系统的基本概念
世界上有着各种各样的存储设备: 内存, 磁带, CD, 磁盘, SSD.

为了访问这些设备, 我们需要驱动程序 (当然内存不需要). 驱动程序的目的就是将设备的机械/电气等特征屏蔽, 提供一个接口, 将设备抽象成一个简单的模型. 如它可以将 SSD 的寻找 page 等等细节都屏蔽, 让系统看到的 SSD 是一个 *线性数组*, 就像 256G 的 SSD 变成 `char ssd[1000*1000*1000*256]` 一样.

但是光有这一步是不够的, 我们希望存储的信息作为 "档案" 的形式存在, 便于索引访问. 这个线性数组还是非常不方便, 写入档案时要小心不要重写已有的档案, 完了还需要记录档案的位置长度等信息. 就是说, 我们需要结构化地管理存储介质上的信息. 这就是文件系统的工作: *将存储在介质上的档案, 以结构化的形式展现*. 为此我们才引入了 "文件", "目录", "符号链接" 等概念.

### rcore 文件系统总体介绍
rcore 的文件系统模型源于 ucore 的文件系统, 而 ucore 的文件系统模型源于 Havard 的 OS161 的文件系统和 Linux 文件系统, 而它们源于传统的 UNIX 文件系统设计. UNIX 文件系统有四个抽象概念

* 文件 (file): UNIX 文件中的内容可理解为是一有序字节 buffer, 文件都有一个方便应用程序识别的文件名称 (也称文件路径名). 典型的文件操作有读、写、创建和删除等.
* 目录项 (dentry): 目录项不是目录, 而是目录的组成部分. 在UNIX中目录被看作一种特定的文件, 而目录项是文件路径中的一部分. 如一个文件路径名是 "/test/testfile", 则包含的目录项为: 根目录“/”, 目录“test”和文件“testfile”.  一般而言, 目录项包含目录项的名字(文件名或目录名)和目录项的索引节点(见下面的描述)位置. 
* 索引节点: UNIX将文件的相关元数据信息(如访问控制权限、大小、拥有者、创建时
间、数据内容等等信息)存储在一个单独的数据结构中, 该结构被称为索引节点. 
* 安装点: 在UNIX中, 文件系统被安装在一个特定的文件路径位置, 这个位置就是安装
点. 所有的已安装文件系统都作为根文件系统树中的叶子出现在系统中. 

上述抽象概念形成了UNIX文件系统的逻辑数据结构,并需要通过一个具体文件系统的架构设
计与实现把上述信息映射并储存到磁盘介质上,从而在具体文件系统的磁盘布局(即数据在
磁盘上的物理组织)上具体体现出上述抽象概念。比如文件元数据信息存储在磁盘块中的索
引节点上。当文件被载入内存时,内核需要使用磁盘块中的索引点来构造内存中的索引节
点。

rcore模仿了UNIX的文件系统设计,rcore的文件系统架构主要由四部分组成:
* 通用文件系统访问接口层:该层提供了一个从用户空间到文件系统的标准访问接口。这
一层访问接口让应用程序能够通过一个简单的接口获得rcore内核的文件系统服务。
* 文件系统抽象层:向上提供一个一致的接口给内核其他部分(文件系统相关的系统调用
实现模块和其他内核功能模块)访问。向下提供一个同样的抽象函数指针列表和数据结
构屏蔽不同文件系统的实现细节。
* Simple FS文件系统层:一个基于索引方式的简单文件系统实例。向上通过各种具体函数
实现以对应文件系统抽象层提出的抽象函数。向下访问外设接口
* 外设接口层:向上提供device访问接口屏蔽不同硬件细节。向下实现访问各种具体设备驱
动的接口,比如disk设备接口/串口设备接口/键盘设备接口等。

从rcore操作系统不同的角度来看,rcore中的文件系统架构包含四类主要的数据结构,	它们分别是:
* 超级块(SuperBlock),它主要从文件系统的全局角度描述特定文件系统的全局信息。
它的作用范围是整个OS空间。
* 索引节点(inode):它主要从文件系统的单个文件的角度它描述了文件的各种属性和数
据所在位置。它的作用范围是整个OS空间。
* 目录项(dentry):它主要从文件系统的文件路径的角度描述了文件路径中的特定目录。
它的作用范围是整个OS空间。
* 文件(file),它主要从进程的角度描述了一个进程在访问文件时需要了解的文件标识,
文件读写的位置,文件引用情况等信息。它的作用范围是某一具体进程。

### 文件系统相关 syscall
操作数据文件, 常见 syscall 有
| syscall | 含义 |
| --- | --- |
| `open(pathname, flags) -> fd` | 读写文件前, 先调用 `open` 取得访问这个文件的句柄 `fd`, 称为文件描述符 (file descriptor) |
| `close(fd)` | 对文件的访问结束后, 调用 `close` 将其关闭. |
| `read(fd, buf, size) -> count` | 从 `fd` 描述的文件中, 读取至多 `size` 字节到 `buf` 中. 返回值 `count` 小于等于 `size`, 表示读取了 `count` 字节的数据. |
| `write(fd, buf, size) -> count` | 将 `buf` 开始的至多 `size` 字节的内存的内容, 写入到 `fd` 描述的文件中. 返回值表示写入了 `count` 字节的数据. |

注意, syscall 一旦失败, 无论是因为参数错误 / 访问越界 / 设备空间满, 都返回 -1.

操作目录, 常见 syscall 有
| syscall | 含义 |
| --- | --- |
| `chdir(path)` | 把当前进程的 cwd (current working directory, 当前工作路径) 切换到 `path` |
| `open(pathname, flags) -> fd` | 同上 |
| `close(fd)` | 同上 |
| `getdirentry(fd, *direntp)` | 读取目录内容到 `direntp` 指向的内存中 |

### 抽象文件系统 VFS
简单说, 就是将不同文件系统的接口抽象出来, 得到一个通用的文件系统接口, 称为 VFS.

**TODO**

### 作为参考的 Simple File System
**TODO**

## 实验报告要求
**TODO**

